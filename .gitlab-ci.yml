image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_TLS_CERTDIR: "/certs"  # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –¥–ª—è Docker
  DOCKER_HOST: tcp://docker:2375  # –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TCP
  DOCKER_DRIVER: overlay2  # –£–∫–∞–∑—ã–≤–∞–µ–º –¥—Ä–∞–π–≤–µ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è Docker
  DOCKER_CLI_EXPERIMENTAL: disabled  # –û—Ç–∫–ª—é—á–∞–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏

stages:
  - build
  - deploy

before_script:
  - echo "Starting pipeline on $(hostname)"
  - docker info

build:
  stage: build
  script:
    - echo "üîß –°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    - docker-compose -f docker-compose.yml build

deploy:
  stage: deploy
  script:
    - echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    - docker-compose -f docker-compose.yml down
    - docker-compose -f docker-compose.yml up -d
